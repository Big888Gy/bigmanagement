<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work management system - ครูบิ๊กกี้</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'TH SarabunPSK', 'Sarabun', sans-serif;
            background-color: #f1f5f9;
        }
        .card {
            background-color: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 24px rgba(149, 157, 165, 0.15);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(0,0,0,0.12);
        }
        .btn-gradient {
            background-image: linear-gradient(to right, #10b981, #06b6d4);
            color: white;
        }
        .btn-info {
            background-image: linear-gradient(to right, #3b82f6, #6366f1);
            color: white;
        }
        input, textarea, select {
            border-radius: 10px !important;
            border: 1px solid #d1d5db !important;
            padding: 0.75rem !important;
            width: 100%;
            transition: all 0.2s ease;
        }
        input:focus, textarea:focus, select:focus {
            border-color: #0d9488 !important;
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.2) !important;
            outline: none;
        }
        .task-item {
            border-left-width: 5px;
            transition: all 0.3s ease;
            background-color: #f8fafc;
            border-radius: 10px;
            overflow: hidden;
        }
        .task-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .priority-ปกติ { border-color: #3b82f6; }
        .priority-ด่วน { border-color: #f97316; }
        .priority-ด่วนที่สุด { border-color: #ef4444; }
        .completed { opacity: 0.6; }
        .completed .task-name { text-decoration: line-through; }
        .loader {
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #0d9488;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #message-box {
            position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem;
            border-radius: 10px; color: white; z-index: 1000;
            opacity: 0; visibility: hidden; transition: all 0.5s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        #message-box.show { opacity: 1; visibility: visible; }
        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 700;
            font-size: 1.2rem;
            color: #475569;
        }
        .tab.active {
            color: #0d9488;
            border-bottom-color: #0d9488;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <header class="text-center mb-8">
            <h1 class="text-5xl md:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-500 to-teal-600">Work management system</h1>
            <p class="text-2xl md:text-3xl text-slate-600 mt-2">ครูบิ๊กกี้  :  นายสุวิศิษฐ์   ก้านจักร</p>
        </header>

        <div class="flex flex-wrap justify-center border-b border-slate-200 mb-8">
            <div id="tab-tasks" class="tab active">จัดการงาน</div>
            <div id="tab-logs" class="tab">บันทึกปฏิบัติงาน</div>
            <div id="tab-links" class="tab">ดูข้อมูล & รายงาน</div>
        </div>

        <!-- Tasks Content -->
        <div id="content-tasks">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-3 space-y-8">
                    <div class="card">
                        <h2 class="text-3xl font-bold mb-6 text-slate-800">เพิ่มงานใหม่</h2>
                        <form id="task-form" class="space-y-4">
                            <div>
                                <label for="task_name" class="block text-slate-700 font-bold mb-2 text-lg">ชื่องาน:</label>
                                <input type="text" id="task_name" name="task_name" required>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="due_date" class="block text-slate-700 font-bold mb-2 text-lg">กำหนดส่ง:</label>
                                    <input type="date" id="due_date" name="due_date" required>
                                </div>
                                <div>
                                    <label for="priority" class="block text-slate-700 font-bold mb-2 text-lg">ความสำคัญ:</label>
                                    <select id="priority" name="priority">
                                        <option value="ปกติ">ปกติ</option>
                                        <option value="ด่วน">ด่วน</option>
                                        <option value="ด่วนที่สุด">ด่วนที่สุด</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-gradient w-full !mt-6 text-lg">เพิ่มงานใหม่</button>
                        </form>
                    </div>
                    <div class="card">
                        <h2 class="text-3xl font-bold mb-4 text-slate-800">ภาพรวมงานทั้งหมด</h2>
                        <div class="max-w-xs mx-auto"><canvas id="taskChart"></canvas></div>
                    </div>
                </div>
                <div class="lg:col-span-2 card">
                    <h2 class="text-3xl font-bold mb-6 text-slate-800">รายการงานที่ต้องทำ</h2>
                    <div id="task-list" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <!-- Logs Content -->
        <div id="content-logs" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card">
                    <h2 class="text-3xl font-bold mb-6 text-slate-800">บันทึกการปฏิบัติงานรายวัน</h2>
                    <form id="log-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="log_date" class="block text-slate-700 font-bold mb-2 text-lg">วันที่:</label>
                                <input type="date" id="log_date" name="log_date" required>
                            </div>
                            <div>
                                <label for="location" class="block text-slate-700 font-bold mb-2 text-lg">สถานที่:</label>
                                <input type="text" id="location" name="location" required>
                            </div>
                        </div>
                        <div>
                            <label for="description" class="block text-slate-700 font-bold mb-2 text-lg">รายละเอียดงาน:</label>
                            <textarea id="description" name="description" rows="3" required></textarea>
                        </div>
                        <div>
                            <label for="image" class="block text-slate-700 font-bold mb-2 text-lg">รูปภาพประกอบ (ถ้ามี):</label>
                            <input type="file" id="image" name="image" accept="image/*">
                        </div>
                        <button type="submit" id="log-submit-btn" class="btn btn-gradient w-full !mt-6 text-lg">บันทึกการปฏิบัติงาน</button>
                    </form>
                </div>
                <div class="card">
                    <h2 class="text-3xl font-bold mb-6 text-slate-800">ประวัติการปฏิบัติงาน</h2>
                    <div id="log-list" class="space-y-4 max-h-[600px] overflow-y-auto pr-2"></div>
                </div>
            </div>
        </div>
        
        <!-- Links & Reports Content -->
        <div id="content-links" class="hidden">
             <div class="card text-center">
                <h2 class="text-3xl font-bold mb-6 text-slate-800">ลิงก์ข้อมูลและรายงาน</h2>
                <p class="text-slate-500 mb-8 max-w-2xl mx-auto">เข้าถึงฐานข้อมูลและส่งรายงานสรุปงานเข้า Telegram ได้จากที่นี่</p>
                <div class="flex flex-col md:flex-row justify-center items-center gap-4">
                    <a href="https://docs.google.com/spreadsheets/d/1WIugQxJBATRWyG6XHgewA783hmtHQE8EjHIMYaPfAXY/edit" target="_blank" class="btn btn-info w-full md:w-auto">
                        📂 เปิด Google Sheet
                    </a>
                    <a href="https://drive.google.com/drive/folders/1PD0v2UjgtfpdSwgwXaJeMAxQm894sKHf" target="_blank" class="btn btn-info w-full md:w-auto">
                        🖼️ เปิด Google Drive
                    </a>
                    <button id="report-btn" class="btn btn-info w-full md:w-auto">
                        📊 ส่งรายงานสรุปเข้า Telegram
                    </button>
                </div>
            </div>
        </div>

        <footer class="text-center mt-12 text-slate-500">
            <p>Copyright © 2024 by BigGy Teacher</p>
        </footer>
    </div>

    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden"><div class="loader"></div></div>
    <div id="message-box"></div>

    <script type="module">
        // --- Configuration ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwiR3cMpi3rGmYhmCTDBlY4b07NMp14zisABcFPMubx_UCupi3W2xPQPK4csvaCfeLk/exec";
        
        let taskChart = null;

        // --- UI Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const messageBox = document.getElementById('message-box');
        const tabTasks = document.getElementById('tab-tasks');
        const tabLogs = document.getElementById('tab-logs');
        const tabLinks = document.getElementById('tab-links');
        const contentTasks = document.getElementById('content-tasks');
        const contentLogs = document.getElementById('content-logs');
        const contentLinks = document.getElementById('content-links');
        const taskForm = document.getElementById('task-form');
        const taskList = document.getElementById('task-list');
        const logForm = document.getElementById('log-form');
        const logList = document.getElementById('log-list');
        const reportBtn = document.getElementById('report-btn');

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadTasks();
            loadLogs();
        });

        // --- Tab Switching ---
        function switchTab(activeTab) {
            tabTasks.classList.toggle('active', activeTab === 'tasks');
            tabLogs.classList.toggle('active', activeTab === 'logs');
            tabLinks.classList.toggle('active', activeTab === 'links');
            contentTasks.classList.toggle('hidden', activeTab !== 'tasks');
            contentLogs.classList.toggle('hidden', activeTab !== 'logs');
            contentLinks.classList.toggle('hidden', activeTab !== 'links');
        }
        tabTasks.addEventListener('click', () => switchTab('tasks'));
        tabLogs.addEventListener('click', () => switchTab('logs'));
        tabLinks.addEventListener('click', () => switchTab('links'));

        // --- Helper Functions ---
        function showLoading(show) { loadingOverlay.classList.toggle('hidden', !show); }
        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = 'show';
            messageBox.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');
            setTimeout(() => messageBox.classList.remove('show'), 3000);
        }

        // --- API Call Functions ---
        async function apiPost(action, data) {
            if (SCRIPT_URL === "YOUR_GOOGLE_APPS_SCRIPT_URL") {
                showMessage("ยังไม่ได้ตั้งค่า Google Apps Script URL", "error");
                return null;
            }
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action, data }),
                    redirect: 'follow'
                });
                return await response.json();
            } catch (error) {
                showMessage("การเชื่อมต่อ API ล้มเหลว", "error");
                console.error("API call error:", error);
                return null;
            }
        }

        async function apiGet(action) {
             if (SCRIPT_URL === "YOUR_GOOGLE_APPS_SCRIPT_URL") return [];
            try {
                const response = await fetch(`${SCRIPT_URL}?action=${action}`);
                return await response.json();
            } catch (error) {
                console.error("Fetch data error:", error);
                return [];
            }
        }

        // --- Task Management ---
        taskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);
            const taskData = {
                name: taskForm.task_name.value,
                dueDate: taskForm.due_date.value,
                priority: taskForm.priority.value,
            };
            const result = await apiPost('addTask', taskData);
            if (result && result.status === 'success') {
                showMessage("บันทึกงานเรียบร้อยแล้ว", "success");
                taskForm.reset();
                loadTasks();
            } else {
                showMessage("เกิดข้อผิดพลาดในการบันทึกงาน", "error");
            }
            showLoading(false);
        });

        async function loadTasks() {
            showLoading(true);
            const tasks = await apiGet('getTasks');
            tasks.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

            if (!tasks || tasks.length === 0) {
                taskList.innerHTML = '<p class="text-slate-500 text-center py-4">เยี่ยมเลย! ไม่มีงานค้างอยู่ตอนนี้</p>';
                updateTaskChart(0, 0, 0);
                showLoading(false);
                return;
            }
            let completed = 0, pending = 0, overdue = 0;
            const today = new Date().setHours(0, 0, 0, 0);
            taskList.innerHTML = '';
            tasks.forEach(task => {
                const dueDate = new Date(task.dueDate).setHours(0, 0, 0, 0);
                if (task.isCompleted) completed++; else if (dueDate < today) overdue++; else pending++;
                
                const taskEl = document.createElement('div');
                taskEl.className = `task-item p-4 flex items-center justify-between priority-${task.priority} ${task.isCompleted ? 'completed' : ''}`;
                taskEl.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-bold text-slate-800 task-name">${task.name}</p>
                        <p class="text-sm text-slate-500">กำหนดส่ง: ${new Date(task.dueDate).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' })}</p>
                    </div>
                    <div class="flex items-center space-x-2 flex-shrink-0 ml-4">
                        <button data-id="${task.id}" data-completed="${task.isCompleted}" class="toggle-complete-btn btn !p-2 text-white ${task.isCompleted ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'}" title="${task.isCompleted ? 'ตั้งเป็นยังไม่เสร็จ' : 'ตั้งเป็นเสร็จสิ้น'}">${task.isCompleted ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>'}</button>
                        <button data-id="${task.id}" class="delete-task-btn btn !p-2 bg-red-500 hover:bg-red-600 text-white" title="ลบงาน"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                    </div>`;
                taskList.appendChild(taskEl);
            });
            updateTaskChart(pending, completed, overdue);
            showLoading(false);
        }
        
        taskList.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const taskId = button.dataset.id;
            
            showLoading(true);
            if (button.classList.contains('toggle-complete-btn')) {
                const isCompleted = button.dataset.completed === 'true';
                await apiPost('updateTask', { id: taskId, isCompleted: !isCompleted });
            } else if (button.classList.contains('delete-task-btn')) {
                await apiPost('deleteTask', { id: taskId });
            }
            loadTasks();
        });

        function updateTaskChart(pending, completed, overdue) {
            const ctx = document.getElementById('taskChart').getContext('2d');
            const data = { labels: ['ยังไม่เสร็จ', 'เสร็จสิ้นแล้ว', 'เกินกำหนด'], datasets: [{ data: [pending, completed, overdue], backgroundColor: ['#3b82f6', '#10b981', '#ef4444'], borderColor: '#ffffff', borderWidth: 4, hoverOffset: 8 }] };
            if (taskChart) { taskChart.data = data; taskChart.update(); } 
            else {
                taskChart = new Chart(ctx, { type: 'doughnut', data, options: { responsive: true, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { font: { family: "'TH SarabunPSK', 'Sarabun', sans-serif", size: 16 }, color: '#475569' } }, tooltip: { callbacks: { label: (c) => `${c.label}: ${c.raw} งาน` } } } } });
            }
        }

        // --- Daily Log Logic ---
        logForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const imageFile = logForm.image.files[0];
            const reader = new FileReader();

            const saveLog = async (imageData = null, imageName = null) => {
                showLoading(true);
                const logData = {
                    logDate: logForm.log_date.value,
                    location: logForm.location.value,
                    description: logForm.description.value,
                    imageData,
                    imageName
                };
                const result = await apiPost('addLog', logData);
                if (result && result.status === 'success') {
                    showMessage("บันทึกการปฏิบัติงานเรียบร้อย", "success");
                    logForm.reset();
                    loadLogs();
                } else {
                    showMessage("เกิดข้อผิดพลาดในการบันทึก", "error");
                }
                showLoading(false);
            };

            if (imageFile) {
                reader.onloadend = () => {
                    saveLog(reader.result, imageFile.name);
                };
                reader.readAsDataURL(imageFile);
            } else {
                saveLog();
            }
        });

        async function loadLogs() {
            const logs = await apiGet('getLogs');
            logs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            if (!logs || logs.length === 0) {
                logList.innerHTML = '<p class="text-slate-500 text-center py-4">ยังไม่มีการบันทึกการปฏิบัติงาน...</p>';
                return;
            }
            logList.innerHTML = '';
            logs.forEach(log => {
                const logEl = document.createElement('div');
                logEl.className = 'p-4 rounded-lg bg-slate-50 border border-slate-200';
                const formattedDate = new Date(log.logDate).toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                logEl.innerHTML = `
                    <p class="font-bold text-slate-800 text-xl">${formattedDate}</p>
                    <p class="text-slate-600 mb-2"><strong>สถานที่:</strong> ${log.location}</p>
                    <p class="text-slate-700 mb-3">${log.description}</p>
                    ${log.imageUrl ? `<a href="${log.imageUrl}" target="_blank" rel="noopener noreferrer"><img src="${log.imageUrl}" alt="ภาพประกอบ" class="mt-2 rounded-lg max-h-48 w-auto hover:opacity-80 transition-opacity"></a>` : ''}
                `;
                logList.appendChild(logEl);
            });
        }
        
        // --- Report Button ---
        reportBtn.addEventListener('click', async () => {
            showLoading(true);
            const result = await apiPost('sendSummaryReport', {});
            if (result && result.status === 'success') {
                showMessage("ส่งรายงานสรุปเข้า Telegram แล้ว!", "success");
            } else {
                showMessage("เกิดข้อผิดพลาดในการส่งรายงาน", "error");
            }
            showLoading(false);
        });

    </script>
</body>
</html>
